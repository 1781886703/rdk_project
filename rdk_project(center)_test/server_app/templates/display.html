{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
    <div class="container">
        <!-- 左上部分：4个设备图片和信息 -->
        <div class="device-display">
            {% for device in devices %}
            <div class="device-box" data-id="{{ device.id }}">
                <p>{{ device.name }} 运行状态: {{ device.status }} 温度: {{ device.temperature }}°C</p>
                <img src="{{ device.image_url }}?t={{ timestamp }}" alt="设备图片">
                <button onclick="selectDevice('{{ device.id }}')">设置 {{ device.id }}</button>
            </div>
            {% endfor %}
        </div>

        <!-- 右上部分：动态设备设置区域 -->
        <div class="settings-panel">
            <h3>设置 {{ selected_device.name }}</h3>
            <label>曝光度:
                <input type="range" min="0" max="100" id="exposure" value="{{ selected_device.settings.warmth }}"
                    oninput="updateSliderValue(this, 'exposureValue')" />
                <span id="exposureValue">{{ selected_device.settings.warmth }}</span>
            </label>
            <label>亮度:
                <input type="range" min="0" max="100" id="brightness" value="{{ selected_device.settings.brightness }}"
                    oninput="updateSliderValue(this, 'brightnessValue')" />
                <span id="brightnessValue">{{ selected_device.settings.brightness }}</span>
            </label>
            <label>对比度:
                <input type="range" min="0" max="100" id="contrast" value="{{ selected_device.settings.contrast }}"
                    oninput="updateSliderValue(this, 'contrastValue')" />
                <span id="contrastValue">{{ selected_device.settings.contrast }}</span>
            </label>
        </div>

        <!-- 左下部分：设备统计信息 -->
        <div class="statistics-panel">
            <h3>统计信息</h3>
            <div class="flex">
                <div id="left_info">
                    <p>红灯个数：{{ statistics.redLights }}</p>
                    <p>绿灯个数：{{ statistics.greenLights }}</p>
                </div>
                <div id="right_info">
                    <p>电动车数量：{{ statistics.electricCars }}</p>
                    <p>汽车车流量：{{ statistics.cars }}</p>
                    <p>总车流量：{{ statistics.totalTraffic }}</p>
                </div>
            </div>
            <p>开始录制时间：{{ statistics.startTime }} 预计结束时间：{{ statistics.endTime }}</p>
        </div>

        <!-- 右下部分：录制控制区域 -->
        <div class="record-control">
            <h3>录制视频</h3>
            <p>已录制时长：<span id="recordedTime">{{ recording_status.recordedTime }}</span> 秒</p>
            <label>单个时长：<input type="range" min="1" max="120" id="segmentTime"
                    value="{{ recording_settings.segmentTime }}"
                    oninput="updateSliderDisplay('segmentTime', 'segmentTimeValue')" /> <span id="segmentTimeValue">{{
                    recording_settings.segmentTime }}</span> 秒</label>
            <label>总时长：<input type="range" min="1" max="300" id="totalTime" value="{{ recording_settings.totalTime }}"
                    oninput="updateSliderDisplay('totalTime', 'totalTimeValue')" /> <span id="totalTimeValue">{{
                    recording_settings.totalTime }}</span> 秒</label>
            <p>地点：<input type="text" id="location" value="{{ recording_settings.location }}" /></p>
            <button id="startButton" onclick="sendCommand('start')">开始</button>
            <button id="stopButton" onclick="sendCommand('stop')" disabled>结束</button>
        </div>
    </div>

    <script>
        function selectDevice(deviceId) {
            // 使用AJAX请求动态更新selected_device数据
            fetch(`/select_device/${deviceId}/`)
                .then(response => response.json())
                .then(data => {
                    document.querySelector(".settings-panel h3").textContent = `设置 ${data.name}`;
                    document.getElementById("exposure").value = data.settings.warmth;
                    document.getElementById("exposureValue").textContent = data.settings.warmth;
                    document.getElementById("brightness").value = data.settings.brightness;
                    document.getElementById("brightnessValue").textContent = data.settings.brightness;
                    document.getElementById("contrast").value = data.settings.contrast;
                    document.getElementById("contrastValue").textContent = data.settings.contrast;
                })
                .catch(error => console.error("Error fetching device data:", error));
        }

        function updateSliderValue(slider, elementId) {
            document.getElementById(elementId).textContent = slider.value;
        }

        function updateSliderDisplay(sliderId, displayId) {
            const slider = document.getElementById(sliderId);
            const display = document.getElementById(displayId);
            display.textContent = slider.value;
        }

        function sendCommand(command) {
                const segmentTime = document.getElementById('segmentTime').value;
                const totalTime = document.getElementById('totalTime').value;
                const location = document.getElementById('location').value;

                console.log("Sending command:", command, "Segment Time:", segmentTime, "Total Time:", totalTime); // 调试输出

                fetch('http://192.168.3.35:8001/handle_recording_command/', {  // 确保路径和 Flask 路由一致
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ command, segment_time: parseInt(segmentTime), total_time: parseInt(totalTime), location })
                }).then(response => response.json())
                    .then(data => console.log(data.status))
                    .catch(error => console.error("Error sending command:", error));
            }


        // 页面加载时获取录制状态
        window.onload = function () {
            fetch('/get_recording_status/')
                .then(response => response.json())
                .then(data => {
                    const { isRecording, recordedTime } = data;
                    document.getElementById("recordedTime").textContent = recordedTime;
                    document.getElementById('startButton').disabled = isRecording;
                    document.getElementById('stopButton').disabled = !isRecording;
                });
        };

        window.onload = function () {
                fetch('/get_recording_status/')
                    .then(response => response.json())
                    .then(data => {
                        const { isRecording, recordedTime } = data;
                        document.getElementById("recordedTime").textContent = recordedTime;
                        document.getElementById('startButton').disabled = isRecording;
                        document.getElementById('stopButton').disabled = !isRecording;
                    });
            };
    </script>
</body>

</html>